<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>localStorage vs. Cookie for token storage :: An Hoang</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="localStorage is not as unsecured as you&#39;d think." />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/posts/localstorage-vs-cookie-for-token-storage/" />


  





  
  <link rel="stylesheet" href="http://localhost:1313/css/buttons.min.3be0bba9fe18b5b77c8fe97175a5ff803eb3b8d6b94a4c43e6c842bc229040f1.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/code.min.00125962708925857e7b66dbc58391d55be1191a3d0ce2034de8c9cd2c481c36.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/fonts.min.90c955c31dd7c0e05aae3d4f583d4d8a2af799d69c961337eaf2a825063a55dd.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/main.min.1d8be2dd1b5de9fdaed058c8c59fcf4485f36619574abfb47ed0cfda4812c16d.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/menu.min.83637a90d903026bc280d3f82f96ceb06c5fc72b7c1a8d686afb5bbf818a29f7.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/post.min.ae96bd858b485e91dd4d30f50f4298bdc371cb1a2a55dcfa043d76a6c95b59b0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/prism.min.9023bbc24533d09e97a51a0a42a5a7bfe4c591ae167c5551fb1d2191d11977c0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/syntax.min.cc789ed9377260d7949ea4c18781fc58959a89287210fe4edbff44ebfc1511b6.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terminal.min.fa7e148bd9d175a5fda1e62ea44a0e535f3bb05f7634ec615154cccbe71b3a9a.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">







<link rel="shortcut icon" href="http://localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="localStorage vs. Cookie for token storage">
<meta property="og:description" content="localStorage is not as unsecured as you&#39;d think." />
<meta property="og:url" content="http://localhost:1313/posts/localstorage-vs-cookie-for-token-storage/" />
<meta property="og:site_name" content="An Hoang" />

  <meta property="og:image" content="http://localhost:1313/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2021-09-24 00:00:00 &#43;0000 UTC" />












</head>
<body>


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    An Hoang
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/showcase">Showcase</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about" >About</a></li>
        
      
        
          <li><a href="/showcase" >Showcase</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/localstorage-vs-cookie-for-token-storage/">localStorage vs. Cookie for token storage</a>
  </h1>
  <div class="post-meta"><time class="post-date">2021-09-24</time><span class="post-author">An7</span><span class="post-reading-time">7 min read (1434 words)</span></div>

  
  
  <img src="/posts/localstorage-vs-cookie-for-token-storage/cover.jpg"
    class="post-cover"
    alt="localStorage vs. Cookie for token storage"
    title="Cover Image" />


  

  <div class="post-content"><div>
        <p>localStorage is not as unsecured as you&rsquo;d think.</p>
<h2 id="update-august-1st-2022">Update August 1st, 2022<a href="#update-august-1st-2022" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>I recently had a new hot take on this subject on YouTube, check it out (please click the image):</p>


    
    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="allowfullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/OTcjpteMB6c?autoplay=0&controls=1&end=0&loop=0&mute=0&start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"
      ></iframe>
    </div>

<h2 id="context">Context<a href="#context" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Some time ago, I had to store the JWT token returned from Strapi in a React web
app. Strapi is a <strong>stateless</strong> server. The React app is <strong>client-side</strong>. Here&rsquo;s
what the internet has to say when I need to learn &ldquo;jwt storage&rdquo;:</p>
<p><img alt="jwt-storage-google" src="/images/uploads/jwt-storage-google_pq7lyt.png"></p>
<p>Seems like most opposed to the idea of using <code>localStorage</code>.</p>
<p>What about &ldquo;react jwt storage&rdquo;?</p>
<p><img alt="react-jwt-storage-google" src="/images/uploads/react-jwt-storage-google_m8on8v.png"></p>
<p>First one that recommends <code>localStorage</code>! Hmm, there are also people that
recommend storing JWT in Cookie. Also, there&rsquo;s a recommendation of using
in-memory storage. <a href="https://auth0.com/docs/secure/security-guidance/data-security/token-storage#browser-in-memory-scenarios">It&rsquo;s not persistent. I don&rsquo;t want to login every page
refreshes.</a> So let&rsquo;s not talk about it.</p>
<p>Let&rsquo;s dig into <a href="https://stackoverflow.com/questions/39176237/how-do-i-store-jwt-and-send-them-with-every-request-using-react">the first StackOverflow post</a> above:</p>
<p><img alt="jwt-first-so-answer" src="/images/uploads/jwt-first-so-answer_kbfpiz.png"></p>
<p>Okay. They said that I should use cookies and refresh token instead. And the
Refresh Token should be stored in a cookie with <code>httpOnly</code> flag. Hold that idea
for a second.</p>
<p>How about <a href="https://stackoverflow.com/questions/69294536/where-to-store-jwt-token-in-react-client-side-in-secure-way">the second post</a>:</p>
<p><img alt="jwt-second-so-answer" src="/images/uploads/jwt-second-so-answer_rhln47.png"></p>
<p>Interesting. Two posts that recommend the same Cookie approach. Look at the 3rd
point. They said that I should store my JWT in a Cookie, because in point number
2, <code>localStorage</code> is exposed to XSS. Is Cookie <strong>immune to XSS</strong>? What about
<strong>CSRF</strong>? My server is stateless, and as you read on this blog post further,
you&rsquo;ll need to implement the <em>Double Submit Cookie</em> CSRF prevention technique
(I&rsquo;m using <strong>stateless</strong> server, remember), which is <strong>NOT</strong> immune to XSS,
because the CSRF token also needs to be present in the request body. Not to
mention that now you have to prevent both XSS <em>and</em> CSRF. Hence the 3rd point is
not valid, in my opinion, just because of the XSS argument alone.</p>
<p>You can see the problem here. Back then, I didn&rsquo;t knowledgeable enough to know
that storing JWT in Cookie have problems. It&rsquo;s easy to blindly listen to these
SO answers when you&rsquo;re starting out as an intern (Yes, I had to implement this
in my internship). Obviously, this needs to be addressed. If someone is in the
same boot as me trying to get into the new Serverless world, they need to know
the reasoning behind these.</p>
<h2 id="original-post-starts-here">Original post starts here:<a href="#original-post-starts-here" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<hr>
<p>You know the drill. Authentication time, you chuck the access token into your
<code>localStorage</code>. Suddenly you have a flashback of bad luck working with
<code>localStorage</code>, namely they could <em>easily</em> be taken by a script via Cross-Site
Scripting. So you turned to <code>httpOnly</code> cookie (along with some other attributes,
stay tuned). You even went as far as using a refresh token, and implement a CSRF
token thing. Solved, right?</p>
<h2 id="you-missed-a-point-about-cookies">You missed a point about cookies<a href="#you-missed-a-point-about-cookies" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Whenever you touch a cookie, you are blessed with a <strong>new</strong> problem: Cross-Site
Request Forgery a.k.a. CSRF. Take this from OWASP Cheat Sheet of CSRF
Prevention, I&rsquo;ll provide an example later.</p>
<blockquote>
<p><a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">Remember that any Cross-Site Scripting (XSS) can be used to defeat all CSRF
mitigation techniques!</a></p>
</blockquote>
<p>Let&rsquo;s switch gears here. I&rsquo;m gonna implement a CSRF mitigation. According to the
Cheat Sheet, I have to implement something called a <em>Double Submit Cookie</em> (I&rsquo;m
cutting corners here, we are in a stateless development age, there&rsquo;s no server
state, just in case you wonder why not the <em>Synchronizer Token Pattern</em>).</p>
<blockquote>
<p><strong>DISCLAIMER</strong>: This is simplified. I&rsquo;m sure there&rsquo;s more sophisticated ways
to perform the CSRF attack.</p>
</blockquote>
<p>I&rsquo;m at the Cheat Sheet. Here&rsquo;s the steps:</p>
<ol>
<li>On the server side, I would have to generate a pseudorandom value and put
them in a cookie.</li>
<li>Every time I need to send out a request, I would put that value (also called
a CSRF token) into a header field, something along the lines of
<code>X-XSRF-Token</code>. The Cookie from step 1 is sent along with the request.</li>
<li>On the server side again, I would have to implement a comparison between
those two.</li>
</ol>
<p>Here&rsquo;s a visualization of what&rsquo;s going on:</p>
<p><img alt="double-submit" src="/images/uploads/double-submit_siyipg.png"></p>
<p>The end result is, if the attacker wants to do the CSRF now, they would need to:</p>
<ol>
<li>Set a freshly dummy value, replacing the CSRF token in the request
body/header. Easy enough. For example:
<pre tabindex="0"><code>POST /user/transfer
X-CSRF-Token: MY_DUMMY_VALUE
</code></pre></li>
<li>Modify the <code>csrfToken</code> cookie to <code>MY_DUMMY_VALUE</code>. <em>Not trivial</em>, but
<a href="https://owasp.org/www-pdf-archive/David_Johansson-Double_Defeat_of_Double-Submit_Cookie.pdf">doable</a>.
<pre tabindex="0"><code>POST /user/transfer
Cookie: csrfToken=MY_DUMMY_VALUE
X-CSRF-Token: MY_DUMMY_VALUE
</code></pre></li>
<li>This request is placed within a malicious site, e.g.
<code>https://malicious.example</code>. Using JavaScript, the POST request is submitted.
Depending on the <code>SameSite</code> flag and the browser&rsquo;s implementation, the
<code>accessToken</code> Cookie would be sent.</li>
</ol>
<p>Okay, it&rsquo;s pretty good if combined with some <code>Cross-Origin-Resource-Policy</code> and
<code>SameSite</code> or some other things. CSRF solved.</p>
<p><a href="https://owasp.org/www-pdf-archive/David_Johansson-Double_Defeat_of_Double-Submit_Cookie.pdf">Now you go read this document from OWASP and find out that your CSRF prevention
attempt is flawed.</a> Then, <em>hopefully not</em>, <a href="https://stackoverflow.com/a/37169633">read this from StackOverflow if
you store the csrfToken not in the cookie, but in localStorage</a>. If you go as
far as using <code>SameSite=Strict</code> setting, remember that <a href="https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery">Setting a cookie as
Strict can affect browsing experience negatively</a>, meaning a setting of
<code>SameSite=Lax</code> still leaves top-level <code>GET</code> alone.</p>
<p>If that&rsquo;s not enough, <strong>not all APIs are equipped with CSRF prevention
framework.</strong> Google &ldquo;Strapi CSRF&rdquo; and you&rsquo;ll basically find nothing besides of
implementing CSRF prevention yourself. Why? Because <em>Strapi is not setting the
token in a cookie</em>.</p>
<p><strong>However</strong>, assuming that CSRF is absolutely prevented, there&rsquo;s still the
elephant in the room, the <em>absolute</em> CSRF prevention buster. Read on.</p>
<h3 id="heres-my-take-on-it">Here&rsquo;s my take on it.<a href="#heres-my-take-on-it" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>See, you still <strong>have to</strong> put the CSRF token in the body, by design. That means
your CSRF token <em>cannot</em> be <code>httpOnly</code>, because it prevents JavaScript from
reading the cookie. Have you realized yet? You&rsquo;ve just achieved Cross-Site
Scripting. If your JavaScript can read your cookie, so do mine.</p>
<p>Here it is again:</p>
<blockquote>
<p><a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">Remember that any Cross-Site Scripting (XSS) can be used to defeat all CSRF
mitigation techniques!</a></p>
</blockquote>
<p><a href="https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-perform-csrf">And here&rsquo;s how.</a></p>
<p>If you say</p>
<blockquote>
<p>But it makes the access token harder for the attacker to get than
localStorage! If not they&rsquo;d just snatch it!</p>
</blockquote>
<p>So what? Take this, <em>your website has a Cross-Site Scripting problem, not CSRF</em>.
Do you sleep well on that? You have just gone full circle. <code>localStorage</code> has
XSS problem, but cookie has CSRF <strong>and</strong> XSS. <em>That&rsquo;s why I&rsquo;m not eating the
cookies</em>.</p>
<p>Side note: About the Refresh Token, it solves nothing. It is still a token.
Store it in the Cookie and you have CSRF <strong>and</strong> XSS, just like a normal token.
You can&rsquo;t use <code>httpOnly</code> if you want to prevent CSRF.</p>
<h2 id="fixing-the-myth-of-localstorage-by-mending-xss">Fixing the myth of localStorage by mending XSS<a href="#fixing-the-myth-of-localstorage-by-mending-xss" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Let&rsquo;s debunk this. You got the XSS problem. <em>Deal with it</em>. There&rsquo;s a reason why
<code>dangerouslySetInnerHTML</code> exists.</p>
<p>So where are you getting these foreign scripts to run on your site? Let&rsquo;s start
with some of the greatest archnemesis of <code>localStorage</code> doubters.</p>
<h3 id="xss-from-node-libraries">XSS from Node libraries<a href="#xss-from-node-libraries" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>I&rsquo;m talking about your <code>node_modules</code> when you&rsquo;re deploying on Vercel or
something. Think about it. There are literally from hundreds to millions of
projects using that very same library. If that happens, you <strong>would</strong> know. You
would definitely know.
<a href="https://docs.gitlab.com/ee/user/application_security/dependency_scanning">Here&rsquo;s something from GitLab to let them check for your development comfort</a>.
Or just run <code>yarn audit</code>.</p>
<h3 id="xss-from-cdn-libraries">XSS from CDN libraries<a href="#xss-from-cdn-libraries" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Alright, here&rsquo;s the interesting part. CDNs can be compromised. Why do you use
them though? Just use NPM. And how do you use TypeScript with CDN anyway? Why
are your libraries not available in NPM? If it&rsquo;s that niche, why not just write
them yourselves if you&rsquo;re literally 1 out of the 3 people that would use those?
<em>Why do I have so many questions for you?</em></p>
<p>If you&rsquo;re using libraries from CDNs I think you&rsquo;re having a bigger problem.</p>
<p><strong>Now, to be clear.</strong> Maybe you are forced to use libraries from CDNs, because
something like &ldquo;They don&rsquo;t update it anymore!&rdquo; or &ldquo;I don&rsquo;t want to use NPM for
my little HTML/CSS/JS project!&rdquo;. I use NPM, it&rsquo;s <strong>the repo</strong> to get JavaScript
libraries from, and I don&rsquo;t have your headache.</p>
<h3 id="xss-from-js-injection">XSS from JS injection<a href="#xss-from-js-injection" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Also called a <em>Stored XSS</em>. Or any JS injection from <em>form inputs</em>. It&rsquo;s pretty
hard to screw up something that would cause XSS without you knowing first-hand.
<a href="https://stackoverflow.com/q/33644499">Take a look at this StackOverflow on why React has some XSS-proof.</a> Make
sure to make use of some ESLint rules, those are pretty handy.</p>
<p>In the nutshell, it&rsquo;s pretty hard these days to get XSS if you&rsquo;re doing things
right.</p>
<h2 id="the-winner">The winner<a href="#the-winner" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p><code>localStorage</code>. I just stripped out a workday of effort in your life by doing
so. There&rsquo;s nothing about that anymore, right? The stereotypical thing about
<code>localStorage</code> is, they have XSS problem, and they do, just as your CSRF
mitigation. Don&rsquo;t overengineer your system.</p>
<p>Here&rsquo;s something you&rsquo;ll dig:
<a href="https://pragmaticwebsecurity.com/articles/oauthoidc/localstorage-xss.html">Why avoiding LocalStorage for tokens is the wrong solution</a></p>

      </div></div>

  
    
<div class="pagination">
  <div class="pagination__title">
    <span class="pagination__title-h">Read other posts</span>
    <hr />
  </div>
  <div class="pagination__buttons">
    
      <a href="http://localhost:1313/posts/software-development-education-in-vietnam-is-extremely-uncertain/" class="button inline prev">
        Software development education in Vietnam is extremely uncertain
      </a>
    
    
      ::
    
    
      <a href="http://localhost:1313/posts/the-undisputable-truth-about-coding-exams/" class="button inline next">
        The undisputable truth about &#34;coding exams&#34;
      </a>
    
  </div>
</div>


  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2024 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
