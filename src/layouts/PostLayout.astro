---
import BaseLayout from "./BaseLayout.astro"
import AuthorInfo from "@components/AuthorInfo";
import { getAuthor } from "src/authors";
import { PostFrontmatter, SEO } from "src/types";
import { MarkdownContent, MarkdownInstance } from "astro";
import PostLastNextNav from "@components/PostLastNextNav";
import PublicationAndModifiedDate from "@components/PublicationAndModifiedDate";

export interface Props {
  content: MarkdownContent<PostFrontmatter>;
}

const { content } = Astro.props as Props;

let allPosts = await Astro.glob<PostFrontmatter>('../pages/blog/posts/*.md');
allPosts = allPosts.sort(
  (a, b) => new Date(b.frontmatter.publication_date).valueOf() -
    new Date(a.frontmatter.publication_date).valueOf()
);
const foundAt = allPosts.findIndex(
  (p) => p.frontmatter.slug === content.slug
);
let lastPost: MarkdownInstance<PostFrontmatter> = null;
let nextPost: MarkdownInstance<PostFrontmatter> = null;
if (foundAt !== -1) {
  lastPost = allPosts[foundAt + 1] ?? null;
  nextPost = allPosts[foundAt - 1] ?? null;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const seo: SEO = {
  title: content.title,
  description: content.excerpt,
  openGraph: {
    title: content.title,
    type: "article",
    description: content.excerpt,
    url: canonicalURL.toString(),
    image: content.cover_url,
    article: {
      authors: [content.author],
      publishedTime: content.publication_date,
      modifiedTime: content.publication_date,
    }
  },
};
---

<BaseLayout seo={seo}>
  <article
    class="px-4 mx-auto my-10 prose dark:prose-invert xl:prose-xl md:my-20 md:px-0 font-serif prose-h1:font-sans">
    <PublicationAndModifiedDate publication_date={content.publication_date} modified_date={content.modified_date} />
    <slot />
    <hr />
    <AuthorInfo author={getAuthor(content.author)} />
    <PostLastNextNav last={lastPost?.frontmatter} next={nextPost?.frontmatter} />
    <script src="https://utteranc.es/client.js" repo="intagaming/hxann.com" issue-term="pathname" theme="github-dark"
      crossorigin="anonymous" async>
      </script>
  </article>
</BaseLayout>