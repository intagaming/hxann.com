---
import type { MarkdownContent, MarkdownInstance } from "astro";
import { getAuthor } from "src/authors";
import type { PostFrontmatter, SEO } from "src/types";

import AuthorInfo from "@/components/AuthorInfo";
import PostLastNextNav from "@/components/PostLastNextNav";
import PublicationAndModifiedDate from "@/components/PublicationAndModifiedDate";

import BaseLayout from "./BaseLayout.astro";

export interface Props {
  content: MarkdownContent<PostFrontmatter>;
}

const { content } = Astro.props as Props;

let allPosts = await Astro.glob<PostFrontmatter>("../posts/*.md");
allPosts = allPosts.sort(
  (a, b) =>
    new Date(b.frontmatter.publication_date).valueOf() -
    new Date(a.frontmatter.publication_date).valueOf()
);
const foundAt = allPosts.findIndex((p) => p.frontmatter.slug === content.slug);
let lastPost: MarkdownInstance<PostFrontmatter> | null = null;
let nextPost: MarkdownInstance<PostFrontmatter> | null = null;
if (foundAt !== -1) {
  lastPost = allPosts[foundAt + 1] ?? null;
  nextPost = allPosts[foundAt - 1] ?? null;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const seo: SEO = {
  title: content.title,
  description: content.excerpt,
  openGraph: {
    title: content.title,
    type: "article",
    description: content.excerpt,
    url: canonicalURL.toString(),
    image: content.cover_url,
    article: {
      authors: [content.author],
      publishedTime: content.publication_date,
      modifiedTime: content.publication_date,
    },
  },
};

const author = getAuthor(content.author);
---

<BaseLayout seo={seo}>
  <article
    class="prose mx-auto my-10 px-4 dark:prose-invert xl:prose-xl md:my-20 md:px-0"
  >
    <PublicationAndModifiedDate
      publication_date={content.publication_date}
      modified_date={content.modified_date}
    />
    <slot />
    <hr />
    {author && <AuthorInfo author={author} />}
    <PostLastNextNav
      last={lastPost?.frontmatter}
      next={nextPost?.frontmatter}
    />
    <script
      src="https://utteranc.es/client.js"
      repo="intagaming/hxann.com"
      issue-term="pathname"
      theme="github-dark"
      crossorigin="anonymous"
      async
    ></script>
  </article>
</BaseLayout>
